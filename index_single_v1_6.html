<!DOCTYPE html><html lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CCHT Study Coach — Single File (v1.6)</title>
<style>

:root{--bg:#0b1220;--card:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--pri:#60a5fa;--ok:#22c55e;--bad:#ef4444;--chip:#1f2937}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1000px;margin:0 auto;padding:16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid #233047;border-radius:14px;padding:16px}
h1{font-size:20px;margin:0 0 10px}
button{background:var(--pri);color:#0b1220;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
button.outline{background:transparent;border:1px solid var(--pri);color:var(--pri)}
.badge,.pill{display:inline-block;padding:3px 8px;border-radius:999px;background:var(--chip);color:#e2e8f0;font-size:12px}
.small{font-size:13px;color:var(--muted)}.muted{color:var(--muted)}
.hide{display:none}.list .item{padding:10px 0;border-top:1px solid #1e293b}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .cell{flex:1;min-width:180px;background:#0c1322;border:1px solid #1d2a3e;border-radius:12px;padding:12px}
.q-stem{font-weight:700;margin:8px 0}
.choice{display:flex;gap:10px;align-items:flex-start;border:1px solid #213047;border-radius:10px;padding:10px;margin:8px 0;cursor:pointer}
.choice .badge{background:#111827}
.choice.correct{border-color:#14532d;background:rgba(34,197,94,.1)}
.choice.incorrect{border-color:#7f1d1d;background:rgba(239,68,68,.08)}
.explain{margin-top:8px;border-left:3px solid #334155;padding-left:10px}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
.progress{height:8px;background:#111827;border-radius:999px;overflow:hidden}
.progress>div{height:100%;width:0;background:var(--pri)}
footer{color:#64748b;margin-top:16px;font-size:12px;text-align:center}
hr.sep{border:0;border-top:1px solid #1e293b;margin:12px 0}
ul.compact{margin:6px 0 0 18px;padding:0}

</style>
</head><body>
<div class="container">

  <div id="home" class="card">
    <div class="topbar">
      <div><h1>CCHT Study Coach</h1>
        <div class="small muted">Single-file version · Explanations show after you answer · Next fixed</div>
      </div>
      <span class="pill" id="modePill">Home</span>
    </div>

    <div class="row" style="margin:10px 0">
      <button id="btnDaily">Daily Drill (10)</button>
      <button id="btnPractice" class="outline">Practice (30)</button>
      <button id="btnHard" class="outline">Hard Mode (60)</button>
      <button id="btnExam" class="outline">Timed Exam (150)</button>
      <button id="btnBooster" class="outline">Weak Areas Booster</button>
    </div>

    <div class="kpi">
      <div class="cell"><div class="small">Today answered</div><div style="font-size:22px" id="todayKpi">0</div></div>
      <div class="cell"><div class="small">Weak spots saved</div><div style="font-size:22px" id="weakKpi">0</div></div>
      <div class="cell"><div class="small">Best recent</div><div style="font-size:22px" id="bestKpi">—</div></div>
    </div>

    <hr class="sep">
    <div class="small">
      <b>How to use:</b> Pick a mode. Answer first, then you'll see the <b>Why</b>, <b>Terms</b>, <b>Why others are wrong</b>, and a <b>Memory tip</b>. Tap <b>Next</b> to continue.
    </div>
  </div>

  <div id="quiz" class="card hide">
    <div class="topbar">
      <div><span class="pill" id="catPill">Mix</span> <span class="pill" id="countPill"><span id="qNum">1</span>/<span id="qTotal">10</span></span></div>
      <div class="pill" id="timer">—</div>
    </div>
    <div class="progress" style="margin:12px 0 6px"><div id="bar"></div></div>
    <div id="qArea"></div>
    <div class="row"><button id="btnNext" class="outline">Next →</button></div>
  </div>

  <div id="results" class="card hide">
    <h1>Results</h1>
    <div id="scoreLine" style="font-size:22px;margin-bottom:10px"></div>
    <div class="kpi">
      <div class="cell"><div class="small">Correct</div><div id="kCorrect" style="font-size:22px">0</div></div>
      <div class="cell"><div class="small">Time</div><div id="kTime" style="font-size:22px">—</div></div>
      <div class="cell"><div class="small">Mode</div><div id="kMode" style="font-size:22px">—</div></div>
    </div>
    <div id="bySection" style="margin-top:12px"></div>
    <div id="byTopic" style="margin-top:12px"></div>
    <h3 style="margin-top:14px">Recent Sessions</h3>
    <div id="histList" class="list"></div>
    <div class="row" style="margin-top:12px;"><button onclick="goHome()">Home</button><button class="outline" onclick="retry()">Retry</button></div>
    <div class="small muted" style="margin-top:10px">App v1.6 (single-file)</div>
  </div>

  <footer>If your browser blocks saving (private mode), quizzes still work — but streaks/booster history won’t persist.</footer>
</div>

<script>
/* Auto-generated medical-term-heavy question bank */
const QUESTIONS = [
  {
    "id": 2001,
    "sec": "Clinical",
    "topic": "Access",
    "stem": "Access infiltration early in tx; swelling at arterial needle site; best step?",
    "choices": [
      "Increase BFR to maintain clearance",
      "Stop pump, control bleeding, ice, re-cannulate at new site per policy",
      "Tighten tape and continue",
      "Raise dialysate temp"
    ],
    "answer": 1,
    "why": "Infiltration = needle out or through vessel wall \u2192 bleeding into tissue; stop pump, hemostasis, cold pack, re-site.",
    "terms": "Infiltration: blood extravasation into tissue after vessel injury; presents with swelling, pain.",
    "wrong": [
      "Higher BFR worsens leakage and trauma.",
      "\u2014",
      "Compression alone without assessment risks further damage.",
      "Dialysate temp does not fix a vascular injury."
    ],
    "tip": "\u201cInfiltrate \u2192 ice & relocate.\u201d"
  },
  {
    "id": 2002,
    "sec": "Clinical",
    "topic": "Monitoring",
    "stem": "Pre-pump arterial pressure is \u2212260 mmHg; venous pressure normal. Most likely cause?",
    "choices": [
      "Kinked return line",
      "Arterial needle against wall / inflow obstruction",
      "Dialysate conductivity error",
      "Clot in venous chamber"
    ],
    "answer": 1,
    "why": "Very negative arterial pressure means inflow resistance before the pump: needle against wall, line kink, clot in arterial limb.",
    "terms": "Pre-pump arterial pressure (AP): negative pressure generated as blood is pulled from access.",
    "wrong": [
      "Return obstructions raise venous pressure, not negative AP.",
      "\u2014",
      "Conductivity alarms reflect dialysate mix, not blood-side pressures.",
      "Venous chamber issues affect venous pressure."
    ],
    "tip": "\u201cNegative AP = problem on the pull.\u201d"
  },
  {
    "id": 2003,
    "sec": "Clinical",
    "topic": "Emergencies",
    "stem": "Sudden chest pain + dyspnea during dialysis, visible air in venous chamber. Priority action?",
    "choices": [
      "Stop ultrafiltration only",
      "Clamp venous line and stop pump; left Trendelenburg; O2",
      "Increase dialysate flow to flush air",
      "Continue and observe"
    ],
    "answer": 1,
    "why": "Air embolism risk: immediately stop the pump and clamp venous line to prevent more air entry; position left Trendelenburg; oxygen; escalate.",
    "terms": "Air embolism: entrained air travels to heart/lungs causing obstruction.",
    "wrong": [
      "UF change alone does not stop air entry.",
      "\u2014",
      "Dialysate flow does not remove intravascular air.",
      "Observation delays critical response."
    ],
    "tip": "\u201cClamp, Stop, Left, O2.\u201d"
  },
  {
    "id": 2004,
    "sec": "Clinical",
    "topic": "Emergencies",
    "stem": "Back pain, chest tightness, hypotension; blood looks cherry-red. Immediate action?",
    "choices": [
      "Return blood and continue slower",
      "Stop dialysis; DO NOT return blood; treat as hemolysis",
      "Give heparin bolus",
      "Raise dialysate temperature"
    ],
    "answer": 1,
    "why": "Hemolysis suspected (RBC destruction). Stop, do NOT return hemolyzed blood; manage per protocol and investigate source (chloramine, temp, kink).",
    "terms": "Hemolysis: RBC rupture \u2192 cherry-red blood, pain, hypotension.",
    "wrong": [
      "Returning hemolyzed blood returns free hemoglobin and potassium.",
      "\u2014",
      "Heparin does not address hemolysis and could worsen bleeding.",
      "High temp may cause hemolysis; raising temp is unsafe."
    ],
    "tip": "\u201cCherry red = stop, don\u2019t return.\u201d"
  },
  {
    "id": 2005,
    "sec": "Clinical",
    "topic": "Complications",
    "stem": "Patient becomes clammy with nausea and yawning; SBP falls 25 mmHg during rapid UF. First step?",
    "choices": [
      "Increase UF to meet goal",
      "Stop/reduce UF; legs up; consider 100\u2013200 mL NS",
      "Raise dialysate temp",
      "Turn off air detector"
    ],
    "answer": 1,
    "why": "Early intradialytic hypotension from volume depletion: decrease/stop UF, position, small NS bolus as ordered.",
    "terms": "Intradialytic hypotension: inadequate effective circulating volume.",
    "wrong": [
      "Worsens hypotension.",
      "\u2014",
      "Warmer dialysate may vasodilate.",
      "Air detector is unrelated."
    ],
    "tip": "\u201cYawn + clammy \u2192 ease the UF.\u201d"
  },
  {
    "id": 2006,
    "sec": "Clinical",
    "topic": "Access",
    "stem": "New AVF with absent continuous thrill and weak diastolic bruit. Next step?",
    "choices": [
      "Proceed with cannulation",
      "Hold cannulation; report possible outflow stenosis",
      "Use smaller needles",
      "Apply tourniquet tightly"
    ],
    "answer": 1,
    "why": "Loss of continuous thrill suggests stenosis/thrombosis. Do not cannulate; escalate per protocol.",
    "terms": "Thrill: palpable vibration from blood flow; should be continuous.",
    "wrong": [
      "Unsafe without evaluation.",
      "\u2014",
      "Needle size doesn\u2019t fix stenosis.",
      "Tourniquet won\u2019t restore thrill."
    ],
    "tip": "\u201cNo thrill? Don\u2019t drill.\u201d"
  },
  {
    "id": 2007,
    "sec": "Clinical",
    "topic": "Access",
    "stem": "Rope-ladder cannulation directions for radiocephalic AVF (typical)?",
    "choices": [
      "Arterial antegrade; venous retrograde",
      "Arterial retrograde; venous antegrade",
      "Both retrograde",
      "Both antegrade"
    ],
    "answer": 1,
    "why": "Typical: arterial toward anastomosis (retrograde), venous toward heart (antegrade). Confirm local policy.",
    "terms": "Antegrade: toward heart; Retrograde: toward anastomosis.",
    "wrong": [
      "Not usual pattern.",
      "\u2014",
      "Not standard practice.",
      "Not standard practice."
    ],
    "tip": "\u201cA back, V forward.\u201d"
  },
  {
    "id": 2008,
    "sec": "Clinical",
    "topic": "Complications",
    "stem": "Persistent cramps during UF despite stable BP. Appropriate response?",
    "choices": [
      "Decrease/pause UF; consider small NS",
      "Increase BFR only",
      "Give heparin",
      "Switch dialyzer size only"
    ],
    "answer": 0,
    "why": "Cramps reflect intravascular volume depletion; lower UF and consider NS per order.",
    "terms": "Cramps: muscle ischemia from volume shifts.",
    "wrong": [
      "Does not treat root cause.",
      "Heparin unrelated.",
      "Dialyzer change without addressing volume won\u2019t help."
    ],
    "tip": "\u201cCramp = clamp the UF.\u201d"
  },
  {
    "id": 2009,
    "sec": "Clinical",
    "topic": "Symptoms",
    "stem": "Pruritus over weeks despite regular dialysis. Common contributor?",
    "choices": [
      "Uremia/inadequate clearance \u00b1 Ca/PO4 issues",
      "Hypoglycemia",
      "High dialysate temp only",
      "Tape allergy always"
    ],
    "answer": 0,
    "why": "Uremia is common; mineral metabolism can contribute; evaluate adequacy and labs.",
    "terms": "Uremia: toxin buildup between treatments.",
    "wrong": [
      "Wrong typical cause.",
      "Temp alone less likely.",
      "Allergy is not \u2018always\u2019."
    ],
    "tip": "\u201cItch = think uremic load.\u201d"
  },
  {
    "id": 2010,
    "sec": "Clinical",
    "topic": "Infection Control",
    "stem": "Correct donning sequence before patient contact:",
    "choices": [
      "Gloves \u2192 Gown \u2192 Mask/Resp \u2192 Eye protection",
      "Gown \u2192 Mask/Resp \u2192 Eye protection \u2192 Gloves",
      "Mask \u2192 Gloves \u2192 Gown \u2192 Eye",
      "Gown \u2192 Gloves \u2192 Mask \u2192 Eye"
    ],
    "answer": 1,
    "why": "Standard donning: Gown, then Mask/Respirator, Eye protection, then Gloves.",
    "terms": "Donning: putting on PPE.",
    "wrong": [
      "Gloves first contaminates early.",
      "\u2014",
      "Order incorrect.",
      "Order incorrect."
    ],
    "tip": "\u201cG-M-E-G.\u201d"
  },
  {
    "id": 2011,
    "sec": "Clinical",
    "topic": "Infection Control",
    "stem": "Common doffing sequence to reduce contamination:",
    "choices": [
      "Gloves \u2192 Eye \u2192 Gown \u2192 Mask",
      "Mask \u2192 Gown \u2192 Gloves \u2192 Eye",
      "Gown \u2192 Mask \u2192 Gloves \u2192 Eye",
      "Eye \u2192 Mask \u2192 Gown \u2192 Gloves"
    ],
    "answer": 0,
    "why": "Remove gloves first (dirtiest), then eye protection, then gown, then mask; perform hand hygiene between steps per policy.",
    "terms": "Doffing: removing PPE.",
    "wrong": [
      "\u2014",
      "Order incorrect.",
      "Order incorrect.",
      "Order incorrect."
    ],
    "tip": "\u201cGloves go first.\u201d"
  },
  {
    "id": 2012,
    "sec": "Clinical",
    "topic": "Dialysate",
    "stem": "Hyperkalemia (K+ 6.3 mEq/L) pre-dialysis. Most appropriate initial bath (per provider order)?",
    "choices": [
      "0 mEq/L",
      "1\u20132 mEq/L",
      "3\u20134 mEq/L",
      "\u22655 mEq/L"
    ],
    "answer": 1,
    "why": "Lower dialysate K (1\u20132) increases potassium gradient/removal; exact bath is provider-ordered.",
    "terms": "Dialysate potassium bath: sets diffusion gradient for K+.",
    "wrong": [
      "0 mEq/L can be risky (arrhythmias).",
      "\u2014",
      "Too high for hyperkalemia.",
      "Much too high."
    ],
    "tip": "\u201cHigh K \u2192 lower K bath.\u201d"
  },
  {
    "id": 2013,
    "sec": "Clinical",
    "topic": "Complications",
    "stem": "Dialysis disequilibrium syndrome likely when?",
    "choices": [
      "Early treatments with rapid urea removal \u2192 headache/confusion",
      "Late in long-term patient with stable clearance",
      "High dialysate temp only",
      "Hypernatremia only"
    ],
    "answer": 0,
    "why": "Rapid osmotic shift between blood/brain during initial or aggressive treatments causes cerebral edema \u2192 headache, confusion, nausea, seizures.",
    "terms": "Disequilibrium: osmotic brain edema during early/rapid dialysis.",
    "wrong": [
      "\u2014",
      "Less typical situation.",
      "Temp doesn\u2019t cause DDS.",
      "Sodium alone \u2260 DDS."
    ],
    "tip": "\u201cFirst treatments = first brain swell.\u201d"
  },
  {
    "id": 2014,
    "sec": "Clinical",
    "topic": "Access",
    "stem": "Steal syndrome is suggested by:",
    "choices": [
      "Warm, pink hand distal to access",
      "Cold, pale, painful hand with paresthesia distal to access",
      "Louder diastolic bruit",
      "Bounding distal pulses"
    ],
    "answer": 1,
    "why": "Arterial flow diverted through access \u2192 distal ischemia (cool, pale, pain, paresthesia).",
    "terms": "Steal: diversion of arterial blood from distal limb.",
    "wrong": [
      "Opposite of ischemia.",
      "\u2014",
      "Diastolic bruit diminished in stenosis.",
      "Unlikely in ischemia."
    ],
    "tip": "\u201cSteal steals warmth and pulse.\u201d"
  },
  {
    "id": 2015,
    "sec": "Clinical",
    "topic": "Infection Control",
    "stem": "Pt with tunneled CVC develops fever/rigors during dialysis. First action?",
    "choices": [
      "Increase dialysate temp",
      "Flush line and continue",
      "Stop tx; obtain cultures per protocol; notify RN/MD",
      "Remove catheter yourself"
    ],
    "answer": 2,
    "why": "Treat as possible CRBSI: stop, culture per protocol, escalate. Catheter removal is provider-directed.",
    "terms": "CRBSI: catheter-related bloodstream infection; fever/rigors during use.",
    "wrong": [
      "Temp rise worsens comfort, not infection.",
      "Continues bacteremia risk.",
      "\u2014",
      "Not within scope."
    ],
    "tip": "\u201cFever on CVC = culture & call.\u201d"
  },
  {
    "id": 2016,
    "sec": "Clinical",
    "topic": "Monitoring",
    "stem": "Venous pressure steadily rising; return line taut. Most likely cause?",
    "choices": [
      "Arterial needle against wall",
      "Kink/clot/clamp on return line",
      "Wrong dialysate concentrate",
      "Low pump speed"
    ],
    "answer": 1,
    "why": "Return-side obstruction increases venous pressure.",
    "terms": "Venous pressure: measures resistance returning blood to patient.",
    "wrong": [
      "Affects arterial pressure more.",
      "\u2014",
      "Mix issues show as conductivity alarms.",
      "Pump speed changes both pressures, not selective."
    ],
    "tip": "\u201cV high = return blocked.\u201d"
  },
  {
    "id": 2017,
    "sec": "Clinical",
    "topic": "Infection Control",
    "stem": "Post-needle removal oozing persists >20 min. Appropriate response?",
    "choices": [
      "Release pressure early",
      "Maintain sterile pressure longer; reassess anticoagulation timing/dose",
      "Apply tight tourniquet proximal",
      "Start heparin infusion"
    ],
    "answer": 1,
    "why": "Prolonged hemostasis suggests anticoagulation effect; maintain pressure and evaluate dosing/timing.",
    "terms": "Hemostasis: stopping bleeding by pressure/clotting.",
    "wrong": [
      "Will worsen bleeding.",
      "\u2014",
      "Tourniquet risks ischemia without fixing cause.",
      "Opposite of needed."
    ],
    "tip": "\u201cIf it oozes, review anticoagulant uses.\u201d"
  },
  {
    "id": 2018,
    "sec": "Clinical",
    "topic": "Access",
    "stem": "AVF aneurysm with thinned shiny skin. Safest plan?",
    "choices": [
      "Cannulate through center",
      "Avoid aneurysmal area; ladder elsewhere / notify for plan",
      "Use larger gauge",
      "Tight tourniquet over aneurysm"
    ],
    "answer": 1,
    "why": "Avoid cannulating compromised aneurysm skin\u2014risk of rupture.",
    "terms": "Aneurysm: localized vessel dilatation from repeated puncture.",
    "wrong": [
      "High rupture risk.",
      "\u2014",
      "Larger needles worsen trauma.",
      "Tourniquet may increase pressure risk."
    ],
    "tip": "\u201cShiny skin? Don\u2019t stick in.\u201d"
  },
  {
    "id": 2019,
    "sec": "Clinical",
    "topic": "Symptoms",
    "stem": "Patient reports itching on dialysis; which lab issue often contributes?",
    "choices": [
      "Low calcium",
      "High phosphorus and PTH",
      "Low BUN",
      "Low creatinine"
    ],
    "answer": 1,
    "why": "Hyperphosphatemia and secondary hyperparathyroidism contribute to pruritus.",
    "terms": "Pruritus: itching; in ESRD linked to Ca/PO4/PTH imbalance.",
    "wrong": [
      "Less typical.",
      "\u2014",
      "Not cause.",
      "Not cause."
    ],
    "tip": "\u201cItch? Think PO4/PTH.\u201d"
  },
  {
    "id": 2020,
    "sec": "Clinical",
    "topic": "Labs",
    "stem": "aPTT mainly monitors effect of:",
    "choices": [
      "Warfarin",
      "Heparin",
      "Erythropoietin",
      "Iron sucrose"
    ],
    "answer": 1,
    "why": "aPTT reflects intrinsic pathway; used for heparin effect when ordered.",
    "terms": "aPTT: activated partial thromboplastin time.",
    "wrong": [
      "Warfarin \u2192 PT/INR.",
      "\u2014",
      "Not anticoagulant.",
      "Not relevant."
    ],
    "tip": "\u201cHeparin \u2192 aPTT.\u201d"
  },
  {
    "id": 2021,
    "sec": "Water",
    "topic": "Chloramine",
    "stem": "AAMI max total chlorine (free+combined) in product water:",
    "choices": [
      "0.1 mg/L",
      "0.5 mg/L",
      "1.0 mg/L",
      "0.01 mg/L"
    ],
    "answer": 0,
    "why": "Limit \u22640.1 mg/L to prevent hemolysis; test after 1st carbon.",
    "terms": "Total chlorine = free chlorine + chloramine; hemolysis risk if high.",
    "wrong": [
      "Too high for AAMI.",
      "Too high.",
      "Too low and impractical to detect reliably."
    ],
    "tip": "\u201cOne TENTH is the LIMIT.\u201d"
  },
  {
    "id": 2022,
    "sec": "Water",
    "topic": "Chloramine",
    "stem": "When to test total chlorine during treatment day?",
    "choices": [
      "Daily only",
      "Before first patient and every 4 hours",
      "Weekly",
      "Monthly"
    ],
    "answer": 1,
    "why": "Test pre-first patient and q4h while patients dialyze.",
    "terms": "Chloramine breakthrough can happen mid-day as carbon exhausts.",
    "wrong": [
      "Insufficient frequency.",
      "\u2014",
      "Too infrequent.",
      "Too infrequent."
    ],
    "tip": "\u201cStart + every 4.\u201d"
  },
  {
    "id": 2023,
    "sec": "Water",
    "topic": "Pretreatment",
    "stem": "Primary purpose of carbon tanks in pretreatment:",
    "choices": [
      "Remove hardness (Ca/Mg)",
      "Remove chlorine/chloramines",
      "Remove endotoxin",
      "Remove sodium"
    ],
    "answer": 1,
    "why": "Carbon adsorbs chlorine and reduces chloramines catalytically.",
    "terms": "GAC = granular activated carbon.",
    "wrong": [
      "Hardness by softener, not carbon.",
      "\u2014",
      "Endotoxin needs RO/ultrafilter.",
      "Not target."
    ],
    "tip": "\u201cCarbon kills chloramines.\u201d"
  },
  {
    "id": 2024,
    "sec": "Water",
    "topic": "System Layout",
    "stem": "Correct pretreatment order to protect RO membranes:",
    "choices": [
      "RO \u2192 Softener \u2192 Carbon \u2192 Ultrafilter",
      "Multimedia \u2192 Softener \u2192 Carbon \u2192 RO \u2192 Ultrafilter",
      "Carbon \u2192 RO \u2192 Softener",
      "Softener \u2192 Ultrafilter \u2192 Carbon \u2192 RO"
    ],
    "answer": 1,
    "why": "Particulate (MMF) \u2192 hardness (softener) \u2192 chlorine (carbon) \u2192 RO \u2192 endotoxin polish (UF).",
    "terms": "RO: reverse osmosis membrane; UF: ultrafilter (endotoxin filter).",
    "wrong": [
      "Order wrong.",
      "\u2014",
      "Order wrong.",
      "Order wrong."
    ],
    "tip": "\u201cSand \u2192 Soft \u2192 Carbon \u2192 RO \u2192 Ultra.\u201d"
  },
  {
    "id": 2025,
    "sec": "Water",
    "topic": "Endotoxin",
    "stem": "Ultrafilter downstream of RO primarily removes:",
    "choices": [
      "Hardness",
      "Chlorine",
      "Bacteria/endotoxin",
      "Sodium"
    ],
    "answer": 2,
    "why": "UF captures bacteria/pyrogens downstream of RO.",
    "terms": "Endotoxin: lipopolysaccharides from gram-negative bacteria.",
    "wrong": [
      "Hardness via softener/RO.",
      "Chlorine via carbon.",
      "\u2014",
      "Sodium via RO."
    ],
    "tip": "\u201cUltra = ultra-clean.\u201d"
  },
  {
    "id": 2026,
    "sec": "Water",
    "topic": "Microbiology",
    "stem": "AAMI limit for bacteria in dialysis water:",
    "choices": [
      "50 CFU/mL",
      "100 CFU/mL",
      "250 CFU/mL",
      "0 CFU/mL"
    ],
    "answer": 1,
    "why": "\u2264100 CFU/mL; endotoxin \u22640.25 EU/mL.",
    "terms": "CFU: colony-forming units per mL.",
    "wrong": [
      "Stricter than standard limit.",
      "\u2014",
      "Too high.",
      "Absolute 0 not required."
    ],
    "tip": "\u201cHundred CFU cap.\u201d"
  },
  {
    "id": 2027,
    "sec": "Water",
    "topic": "Microbiology",
    "stem": "Product water culture 120 CFU/mL. Response:",
    "choices": [
      "Continue; within limits",
      "Recheck next month",
      "Disinfect/sanitize and retest per policy",
      "Increase RO pressure only"
    ],
    "answer": 2,
    "why": "Exceeds limit; perform corrective actions and retest before patient use.",
    "terms": "Corrective action: sanitize loop/RO, verify filters.",
    "wrong": [
      "Not within limits.",
      "Too slow.",
      "\u2014",
      "Pressure doesn\u2019t kill microbes."
    ],
    "tip": "\u201c>100? Disinfect & double-check.\u201d"
  },
  {
    "id": 2028,
    "sec": "Water",
    "topic": "Hardness",
    "stem": "Hardness detected after softener indicates:",
    "choices": [
      "RO failure",
      "Softener resin exhaustion\u2014regenerate/service",
      "Carbon breakthrough",
      "Loop biofilm only"
    ],
    "answer": 1,
    "why": "Hardness post-softener means resin exhaustion or valve issue; regenerate/service.",
    "terms": "Hardness: Ca/Mg ions that scale membranes.",
    "wrong": [
      "RO failure shows high conductivity too.",
      "\u2014",
      "Carbon is for chlorine, not hardness.",
      "Biofilm relates to micro, not hardness."
    ],
    "tip": "\u201cHard after soft? Service soft.\u201d"
  },
  {
    "id": 2029,
    "sec": "Water",
    "topic": "Monitoring",
    "stem": "RO product water conductivity suddenly rises. First check:",
    "choices": [
      "Machine concentrate proportioning/mixing",
      "Replace carbon immediately",
      "Regenerate softener first",
      "Ignore transient change"
    ],
    "answer": 0,
    "why": "Verify machine mixing/proportioning; persistent rise may indicate RO issue.",
    "terms": "Conductivity: measure of ionic content; high = more ions.",
    "wrong": [
      "May be needed but first verify mixing.",
      "Not first line.",
      "Ignoring may risk patient."
    ],
    "tip": "\u201cConductivity up? Check the jugs.\u201d"
  },
  {
    "id": 2030,
    "sec": "Water",
    "topic": "Chloramine",
    "stem": "Chloramine exposure in patients primarily causes:",
    "choices": [
      "Hemolysis",
      "Hyperkalemia",
      "Hypoglycemia",
      "Hypertension only"
    ],
    "answer": 0,
    "why": "Chloramines damage RBCs causing hemolysis.",
    "terms": "Chloramine: combined chlorine; toxic to RBCs.",
    "wrong": [
      "\u2014",
      "Not primary.",
      "No.",
      "BP effect is not primary toxicity."
    ],
    "tip": "\u201cChlora-MINES the RBCs.\u201d"
  },
  {
    "id": 2031,
    "sec": "Water",
    "topic": "Chloramine",
    "stem": "Why two carbon tanks in series?",
    "choices": [
      "Increase flow only",
      "Redundancy if first breaks through",
      "Adjust pH",
      "Remove sodium"
    ],
    "answer": 1,
    "why": "Second tank protects if first is exhausted\u2014safety redundancy.",
    "terms": "Breakthrough: chlorine exceeds safe level after first tank.",
    "wrong": [
      "Flow is secondary.",
      "\u2014",
      "Not pH device.",
      "Sodium via RO."
    ],
    "tip": "\u201c#2 = backup.\u201d"
  },
  {
    "id": 2032,
    "sec": "Water",
    "topic": "Microbiology",
    "stem": "Monthly water testing typically includes:",
    "choices": [
      "Total chlorine only",
      "Microbiological culture and endotoxin",
      "pH only",
      "Hardness only"
    ],
    "answer": 1,
    "why": "AAMI requires monthly micro + endotoxin testing.",
    "terms": "Endotoxin test often via LAL assay (EU/mL).",
    "wrong": [
      "Insufficient.",
      "\u2014",
      "Incomplete.",
      "Incomplete."
    ],
    "tip": "\u201cMonthly = microbes.\u201d"
  },
  {
    "id": 2033,
    "sec": "Water",
    "topic": "Chloramine",
    "stem": "Best sampling point for total chlorine performance check:",
    "choices": [
      "After RO",
      "After first carbon tank",
      "At machine drain",
      "After ultrafilter"
    ],
    "answer": 1,
    "why": "Sampling after 1st carbon detects breakthrough early.",
    "terms": "Performance sampling ensures upstream protection works.",
    "wrong": [
      "Too late; RO may mask problem.",
      "\u2014",
      "Not representative.",
      "Downstream of UF not for chlorine."
    ],
    "tip": "\u201cTest after #1.\u201d"
  },
  {
    "id": 2034,
    "sec": "Water",
    "topic": "Endotoxin",
    "stem": "Endotoxin rises downstream despite normal RO performance. Suspect:",
    "choices": [
      "Softener resin exhaustion",
      "Ultrafilter integrity/biofilm issue",
      "Carbon breakthrough",
      "Higher bicarbonate concentrate"
    ],
    "answer": 1,
    "why": "Post-RO endotoxin rise points to endotoxin filter/loop biofilm.",
    "terms": "Biofilm: microbial layer inside piping.",
    "wrong": [
      "Hardness issue, not endotoxin.",
      "\u2014",
      "Carbon is for chlorine.",
      "Not related."
    ],
    "tip": "\u201cEndotoxin up? Check ultra/loop.\u201d"
  },
  {
    "id": 2035,
    "sec": "Water",
    "topic": "RO Mechanics",
    "stem": "RO high-pressure pump cavitation shows as:",
    "choices": [
      "Smooth quiet operation",
      "Rattling/rumbling with pressure fluctuations",
      "Only higher conductivity",
      "Only lower TMP"
    ],
    "answer": 1,
    "why": "Cavitation creates noise/vibration and unstable pressures; can damage pump.",
    "terms": "Cavitation: vapor bubble collapse in pump due to NPSH issues.",
    "wrong": [
      "Opposite of symptoms.",
      "\u2014",
      "May occur but not hallmark.",
      "TMP is dialyzer metric."
    ],
    "tip": "\u201cCavitation = clatter + swings.\u201d"
  },
  {
    "id": 2036,
    "sec": "Water",
    "topic": "Pretreatment",
    "stem": "If prefilter (MMF) differential pressure rises sharply:",
    "choices": [
      "Prefilter is bypassing",
      "Prefilter is loading/clogging with particulates",
      "RO membrane ruptured",
      "Softener resin exhausted"
    ],
    "answer": 1,
    "why": "Rising dP indicates clogging; replace/backwash per protocol.",
    "terms": "Differential pressure: inlet\u2013outlet pressure across filter.",
    "wrong": [
      "Opposite.",
      "\u2014",
      "Would show via conductivity/membrane tests.",
      "Hardness issue instead."
    ],
    "tip": "\u201cdP up = dirt up.\u201d"
  },
  {
    "id": 2037,
    "sec": "Water",
    "topic": "Concentrates",
    "stem": "Bicarbonate mixing error (too concentrated) will most directly cause:",
    "choices": [
      "Low conductivity alarm",
      "High conductivity alarm",
      "No alarm",
      "Air detector alarm"
    ],
    "answer": 1,
    "why": "Too much concentrate raises dialysate conductivity.",
    "terms": "Conductivity reflects ionic strength; more bicarb \u2191 mS/cm.",
    "wrong": [
      "Opposite.",
      "\u2014",
      "It will alarm.",
      "Unrelated."
    ],
    "tip": "\u201cStrong soup = strong conductance.\u201d"
  },
  {
    "id": 2038,
    "sec": "Water",
    "topic": "Chloramine",
    "stem": "If total chlorine after 1st carbon is 0.2 mg/L pre-day:",
    "choices": [
      "Proceed; retest in 4h",
      "Do NOT start patients; correct and retest until \u22640.1 mg/L",
      "Bypass RO",
      "Add more bicarbonate"
    ],
    "answer": 1,
    "why": "Above limit \u2192 unsafe; fix and retest before treatments.",
    "terms": "Exceeding AAMI increases hemolysis risk.",
    "wrong": [
      "Too risky.",
      "\u2014",
      "Bypass RO is not relevant.",
      "Not related."
    ],
    "tip": "\u201cOver limit? No patients.\u201d"
  },
  {
    "id": 2039,
    "sec": "Machine",
    "topic": "Setup",
    "stem": "Dialysate temperature reads 38.5\u00b0C pre-connection. Best action?",
    "choices": [
      "Start treatment",
      "Lower to ~36\u201337\u00b0C before starting",
      "Increase sodium then start",
      "Run saline then start"
    ],
    "answer": 1,
    "why": "Out-of-range temperature is unsafe; correct before connecting patient.",
    "terms": "Dialysate temp target typically ~36\u201337\u00b0C unless ordered otherwise.",
    "wrong": [
      "Unsafe.",
      "\u2014",
      "Not a fix for temp violation.",
      "Not corrective."
    ],
    "tip": "\u201cHigh temp? Halt.\u201d"
  },
  {
    "id": 2040,
    "sec": "Machine",
    "topic": "Safety",
    "stem": "Blood leak alarm + pink effluent. Next step:",
    "choices": [
      "Continue; sensor error",
      "Stop tx; perform blood leak test; replace dialyzer/circuit",
      "Increase dialysate flow",
      "Silence alarm"
    ],
    "answer": 1,
    "why": "Treat as membrane breach until proven otherwise.",
    "terms": "Blood leak: RBCs crossing to dialysate \u2192 pink effluent.",
    "wrong": [
      "Unsafe.",
      "\u2014",
      "Not helpful.",
      "Unsafe."
    ],
    "tip": "\u201cPink effluent = stop & swap.\u201d"
  },
  {
    "id": 2041,
    "sec": "Machine",
    "topic": "Monitoring",
    "stem": "TMP steadily rising with falling clearance. Likely cause:",
    "choices": [
      "Dialyzer clotting/fouling",
      "Access recirculation only",
      "Low conductivity",
      "High dialysate temp"
    ],
    "answer": 0,
    "why": "Clotting/fouling \u2191 resistance \u2192 TMP \u2191, clearance \u2193.",
    "terms": "TMP: transmembrane pressure across dialyzer.",
    "wrong": [
      "Recirculation affects adequacy but not TMP directly.",
      "Conductivity is dialysate metric.",
      "Temp not main driver."
    ],
    "tip": "\u201cGummed filter = high TMP.\u201d"
  },
  {
    "id": 2042,
    "sec": "Machine",
    "topic": "Safety",
    "stem": "Extracorporeal circuit opened to air at a connection. Correct action:",
    "choices": [
      "Clamp and continue",
      "Return blood and continue",
      "Discard circuit and set up new",
      "Give heparin and proceed"
    ],
    "answer": 2,
    "why": "Air exposure risks contamination/emboli; replace set.",
    "terms": "Open system: loss of sterility; air entry risk.",
    "wrong": [
      "Unsafe.",
      "Returning possibly contaminated blood is unsafe.",
      "\u2014",
      "Irrelevant."
    ],
    "tip": "\u201cAir touch? Toss the set.\u201d"
  },
  {
    "id": 2043,
    "sec": "Machine",
    "topic": "Setup",
    "stem": "Low conductivity alarm after setup. First check:",
    "choices": [
      "Concentrates connected/mixed correctly",
      "UF profile settings",
      "Air detector sensitivity",
      "Dry weight"
    ],
    "answer": 0,
    "why": "Misconnected/empty/mis-mixed concentrates common cause.",
    "terms": "Proportioning: acid/bicarb mixing to set conductivity.",
    "wrong": [
      "UF profile unrelated.",
      "Air detector unrelated.",
      "DW is patient-specific."
    ],
    "tip": "\u201cLow cond \u2192 check jugs.\u201d"
  },
  {
    "id": 2044,
    "sec": "Machine",
    "topic": "Monitoring",
    "stem": "Very positive venous pressure with normal AP suggests:",
    "choices": [
      "Inflow obstruction",
      "Return-side obstruction (kink/clot/clamp)",
      "Wrong dialyzer",
      "Air detector malfunction"
    ],
    "answer": 1,
    "why": "Return obstruction elevates venous pressure.",
    "terms": "AP: negative; VP: positive; watch trends.",
    "wrong": [
      "Would make AP more negative.",
      "\u2014",
      "Not pressure-specific.",
      "Different issue."
    ],
    "tip": "\u201cV high = return blocked.\u201d"
  },
  {
    "id": 2045,
    "sec": "Machine",
    "topic": "Safety",
    "stem": "Arterial air detected repeatedly. Best prevention includes:",
    "choices": [
      "Turn off alarm briefly",
      "Ensure secure connections and prime thoroughly; correct chamber level",
      "Lower dialysate temp",
      "Use smaller dialyzer"
    ],
    "answer": 1,
    "why": "Good priming and correct chamber level reduce air alarms; never disable detector.",
    "terms": "Air detector: last line of defense.",
    "wrong": [
      "Unsafe.",
      "\u2014",
      "Not related.",
      "Not primary."
    ],
    "tip": "\u201cPrime right; level right.\u201d"
  },
  {
    "id": 2046,
    "sec": "Machine",
    "topic": "Safety",
    "stem": "Saline bag empties into venous line unnoticed; patient becomes dyspneic. Risk?",
    "choices": [
      "Hemolysis",
      "Air embolism",
      "Hyperkalemia",
      "Dialyzer clotting"
    ],
    "answer": 1,
    "why": "If line ran dry, air can enter \u2192 embolism.",
    "terms": "Air lock: bolus of air to venous side \u2192 embolism.",
    "wrong": [
      "Not mechanism.",
      "\u2014",
      "Not related.",
      "Not immediate."
    ],
    "tip": "\u201cDry bag \u2192 air risk.\u201d"
  },
  {
    "id": 2047,
    "sec": "Machine",
    "topic": "Concentrates",
    "stem": "High dialysate conductivity with patient complaints of headache and hypertension suggests:",
    "choices": [
      "Hypotonic dialysate",
      "Hypertonic dialysate from concentrate error",
      "Membrane rupture",
      "Air entrainment"
    ],
    "answer": 1,
    "why": "Too-strong dialysate (hypertonic) can raise BP and cause headaches.",
    "terms": "Hypertonic: higher solute concentration than plasma.",
    "wrong": [
      "Opposite.",
      "\u2014",
      "Would cause blood leak signs.",
      "Air gives SOB/chest pain."
    ],
    "tip": "\u201cStrong soup \u2192 strong pressure.\u201d"
  },
  {
    "id": 2048,
    "sec": "Machine",
    "topic": "Monitoring",
    "stem": "Arterial pressure trending toward 0 (less negative) while VP normal may indicate:",
    "choices": [
      "Arterial needle dislodged from access drawing from saline/venous chamber",
      "Return-side clot",
      "Wrong concentrates",
      "High TMP"
    ],
    "answer": 0,
    "why": "If arterial needle out or sucking from chamber, resistance drops \u2192 AP less negative toward 0.",
    "terms": "AP near 0 = not pulling from patient properly.",
    "wrong": [
      "Would raise VP.",
      "Concentrates affect conductivity.",
      "TMP relates to dialyzer."
    ],
    "tip": "\u201cAP ~0? You\u2019re not pulling.\u201d"
  },
  {
    "id": 2049,
    "sec": "Role/IC",
    "topic": "Professionalism",
    "stem": "Patient refuses to continue. Best response:",
    "choices": [
      "Continue anyway for safety",
      "Educate on risks, document refusal, notify RN/MD",
      "Reduce UF secretly to compromise",
      "Have another patient persuade them"
    ],
    "answer": 1,
    "why": "Respect autonomy; educate on risks/benefits, document, and escalate appropriately.",
    "terms": "Autonomy: patient\u2019s right to refuse treatment.",
    "wrong": [
      "Violates autonomy.",
      "\u2014",
      "Unethical/unsafe.",
      "Unprofessional."
    ],
    "tip": "\u201cTeach, write, tell RN.\u201d"
  },
  {
    "id": 2050,
    "sec": "Role/IC",
    "topic": "Communication",
    "stem": "Best structured handoff method to RN:",
    "choices": [
      "Casual chat",
      "SBAR (Situation, Background, Assessment, Recommendation)",
      "Text MD without RN",
      "Wait for shift change"
    ],
    "answer": 1,
    "why": "SBAR standardizes information, reducing error.",
    "terms": "SBAR: widely used handoff tool.",
    "wrong": [
      "Not reliable.",
      "\u2014",
      "Breaks chain.",
      "Delays care."
    ],
    "tip": "\u201cSBAR = speak smart.\u201d"
  },
  {
    "id": 2051,
    "sec": "Role/IC",
    "topic": "HIPAA",
    "stem": "Confidentiality requires you to:",
    "choices": [
      "Discuss in public if de-identified",
      "Share info only with staff involved in care",
      "Share with family without consent",
      "Post anonymized details online"
    ],
    "answer": 1,
    "why": "Limit disclosures to care team per policy/consent.",
    "terms": "HIPAA principles apply to dialysis facilities.",
    "wrong": [
      "Public spaces not private.",
      "\u2014",
      "Need consent.",
      "Still risky."
    ],
    "tip": "\u201cNeed-to-know only.\u201d"
  },
  {
    "id": 2052,
    "sec": "Role/IC",
    "topic": "Triage",
    "stem": "Multiple patients need help; who first?",
    "choices": [
      "First come, first served",
      "Most unstable/critical first",
      "Finish paperwork first",
      "Quiet patient last"
    ],
    "answer": 1,
    "why": "Triage by acuity for safety.",
    "terms": "Acuity-based prioritization improves outcomes.",
    "wrong": [
      "Not safe.",
      "\u2014",
      "Delays care.",
      "Not ethical."
    ],
    "tip": "\u201cSickest first.\u201d"
  },
  {
    "id": 2053,
    "sec": "Role/IC",
    "topic": "Exposure",
    "stem": "Sharps needlestick exposure: first step?",
    "choices": [
      "Finish current task",
      "Wash area, report immediately, follow exposure protocol",
      "Bandage and ignore",
      "Wait for symptoms"
    ],
    "answer": 1,
    "why": "Immediate washing and reporting allows timely prophylaxis.",
    "terms": "Post-exposure prophylaxis time-sensitive.",
    "wrong": [
      "Unsafe.",
      "\u2014",
      "Insufficient.",
      "Too late."
    ],
    "tip": "\u201cWash \u2192 Report \u2192 Protocol.\u201d"
  },
  {
    "id": 2054,
    "sec": "Role/IC",
    "topic": "Scope",
    "stem": "Scope of practice for dialysis technician includes:",
    "choices": [
      "Prescribe heparin",
      "Diagnose stenosis",
      "Initiate/monitor tx per orders; report abnormalities",
      "Change provider orders in machine"
    ],
    "answer": 2,
    "why": "Techs perform ordered care and report changes; no diagnosing/prescribing.",
    "terms": "Scope defined by state/facility policies.",
    "wrong": [
      "Out of scope.",
      "Out of scope.",
      "\u2014",
      "Out of scope."
    ],
    "tip": "\u201cDo ordered care; don\u2019t order care.\u201d"
  },
  {
    "id": 2055,
    "sec": "Role/IC",
    "topic": "Exposure",
    "stem": "Hepatitis B post-exposure for non-immune staff should include:",
    "choices": [
      "Wait for symptoms",
      "Immediate report; HBV vaccine/immune globulin per protocol",
      "No action if asymptomatic",
      "Start antibiotics"
    ],
    "answer": 1,
    "why": "Follow exposure protocol; HBV vaccination/HBIG based on status.",
    "terms": "HBV PEP: time-sensitive immunoprophylaxis.",
    "wrong": [
      "Too late.",
      "\u2014",
      "Incorrect.",
      "Antibiotics don\u2019t prevent HBV."
    ],
    "tip": "\u201cExpose? Report \u2192 HBV steps.\u201d"
  },
  {
    "id": 2056,
    "sec": "Role/IC",
    "topic": "Infection Control",
    "stem": "Cleaning surfaces: why respect disinfectant contact time?",
    "choices": [
      "Smells better",
      "Ensures claimed pathogen kill",
      "Saves money",
      "Dries quicker"
    ],
    "answer": 1,
    "why": "Wet contact time is required for the disinfectant\u2019s log-kill claim.",
    "terms": "Contact time = dwell time a surface stays visibly wet.",
    "wrong": [
      "Irrelevant.",
      "\u2014",
      "Not purpose.",
      "Opposite."
    ],
    "tip": "\u201cWet time = kill time.\u201d"
  }
];

</script>
<script>

// CCHT Study Coach script — FIXED for 'Next' and 'show explain after answer'
const APP_VERSION = '1.6'; console.log('CCHT script version:', APP_VERSION);

// Utilities
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}
function storageAvailable(){try{const x='__t__';localStorage.setItem(x,x);localStorage.removeItem(x);return true}catch(e){return false}}
const STORAGE_OK = storageAvailable();
const store={get:(k,f)=>{if(!STORAGE_OK)return f;try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}},
             set:(k,v)=>{if(!STORAGE_OK)return;try{localStorage.setItem(k,JSON.stringify(v))}catch{}}};
const $=sel=>document.querySelector(sel), $$=sel=>Array.from(document.querySelectorAll(sel));
function secondsToMMSS(s){const m=Math.floor(s/60),ss=('0'+(s%60)).slice(-2);return `${m}:${ss}`}

// Keys
const WRONG_KEY='ccht_wrong_v6', STATS_KEY='ccht_stats_v6', HIST_KEY='ccht_hist_v6', PERF_KEY='ccht_perf_v6';

let wrongSet=new Set(store.get(WRONG_KEY,[]));
let stats=store.get(STATS_KEY,{answeredToday:0});
let history=store.get(HIST_KEY,[]);
let perf=store.get(PERF_KEY,{}); // perf[section][topic] = {right,total}

let session=null;
let answeredThis=false; // only true after user selects an answer

function ensurePerf(sec,topic){
  if(!perf[sec]) perf[sec]={};
  if(!perf[sec][topic]) perf[sec][topic]={right:0,total:0};
}

function refreshKPIs(){
  const todayEl=$('#todayKpi'), weakEl=$('#weakKpi'), bestEl=$('#bestKpi');
  if(todayEl) todayEl.textContent=String(stats.answeredToday||0);
  if(weakEl) weakEl.textContent=String(wrongSet.size||0);
  const last=history[history.length-1];
  if(bestEl) bestEl.textContent = last? `${Math.round((last.score||0)*100)}%` : '—';
}

function pickQuestions(mode){
  const pool = shuffle(QUESTIONS.slice());
  // Shuffle answers for each question
  pool.forEach(q=>{
    const zipped = q.choices.map((c,i)=>({c,i}));
    shuffle(zipped);
    q._choices = zipped.map(z=>z.c);
    q._answer = zipped.findIndex(z=>z.i===q.answer);
  });
  if(mode==='daily') return pool.slice(0,10);
  if(mode==='practice') return pool.slice(0,30);
  if(mode==='hard') return pool.slice(0,60);
  if(mode==='exam'){
    const need=150, out=[]; while(out.length<need){ out.push(...shuffle(pool)); } return out.slice(0,need);
  }
  if(mode==='booster'){
    const tuples=[];
    for(const sec in perf){ for(const topic in perf[sec]){
      const v=perf[sec][topic]; const pct = v.total? v.right/v.total : 0;
      tuples.push({sec,topic,pct,total:v.total});
    }}
    if(!tuples.length){ alert('No history yet — do a session first.'); return null; }
    tuples.sort((a,b)=>a.pct-b.pct || a.total-b.total);
    const targets=tuples.slice(0,3);
    const filtered = pool.filter(q=> targets.some(t=>t.sec===q.sec && t.topic===q.topic) );
    return filtered.slice(0,30);
  }
  return pool.slice(0,10);
}

function startSession({mode, timeLimit=null, showImmediate=true}){
  const list = pickQuestions(mode);
  if(!list) return;
  session={mode,list,index:0,answers:[],start:Date.now(),timeLimit,ended:false,showImmediate};
  $('#home')?.classList.add('hide'); $('#results')?.classList.add('hide'); $('#quiz')?.classList.remove('hide');
  $('#modePill') && ($('#modePill').textContent=mode.toUpperCase());
  $('#qTotal') && ($('#qTotal').textContent=String(list.length));
  $('#timer') && ($('#timer').textContent=timeLimit?secondsToMMSS(timeLimit):'—');
  $('#catPill') && ($('#catPill').textContent='Mix');
  showCurrent();
  if(timeLimit){
    const tick=()=>{
      if(!session||session.ended)return;
      const left=timeLimit-Math.floor((Date.now()-session.start)/1000);
      $('#timer') && ($('#timer').textContent=secondsToMMSS(Math.max(0,left)));
      if(left<=0){ finishSession(true); } else setTimeout(tick,1000);
    }; tick();
  }
}

function showCurrent(){
  answeredThis=false;
  const nextBtn = document.getElementById('btnNext');
  if(nextBtn){ nextBtn.disabled = true; nextBtn.style.opacity = 0.6; }

  const q=session.list[session.index];
  $('#qNum') && ($('#qNum').textContent=String(session.index+1));
  $('#bar') && ($('#bar').style.width=((session.index)/session.list.length*100)+'%');
  const area=$('#qArea'); if(!area) return; area.innerHTML='';
  const card=document.createElement('div');
  const choicesArr = (q._choices||q.choices);
  const choicesHtml = choicesArr.map((c,i)=>`<div class="choice" data-i="${i}" role="button" tabindex="0"><div class="badge">${String.fromCharCode(65+i)}</div><div>${c}</div></div>`).join('');
  card.innerHTML=`
    <div class="q-stem">${q.stem} <span class="pill" style="margin-left:6px">${q.sec}</span> <span class="pill" style="margin-left:6px">${q.topic}</span></div>
    ${choicesHtml}
    <div class="explain small ${session.showImmediate?'hide':''}" id="explain">
      <div><b>Why:</b> ${q.why}</div>
      <div><b>Terms:</b> ${q.terms}</div>
      <div><b>Why others are wrong:</b><ul class="compact">${
        (q.wrong||[]).map(w=>`<li>${w}</li>`).join('')
      }</ul></div>
      <div><b>Memory tip:</b> ${q.tip}</div>
    </div>`;
  area.appendChild(card);
  const status=document.createElement('div'); status.id='status'; status.className='small muted'; status.style.marginTop='6px';
  status.textContent = session.showImmediate ? 'Select an answer to see the explanation, then tap Next.'
                                            : 'Practice exam mode — answers/explanations at the end.';
  area.appendChild(status);

  // Bind click
  $$('#qArea .choice').forEach(ch=>ch.addEventListener('click',()=>{
    if(ch.classList.contains('locked')) return;
    const pick=Number(ch.dataset.i);
    const correctIndex = (q._answer!=null)? q._answer : q.answer;
    $$('#qArea .choice').forEach((n,i)=>{ n.classList.add('locked'); if(i===correctIndex) n.classList.add('correct'); if(i===pick && i!==correctIndex) n.classList.add('incorrect'); });
    const correct = pick===correctIndex;

    stats.answeredToday+=1; store.set(STATS_KEY, stats);
    ensurePerf(q.sec,q.topic); perf[q.sec][q.topic].total += 1; if(correct) perf[q.sec][q.topic].right += 1; store.set(PERF_KEY, perf);
    if(!correct) wrongSet.add(q.id); else wrongSet.delete(q.id); store.set(WRONG_KEY, Array.from(wrongSet));

    // Show explanation AFTER answering (only for immediate modes)
    if(session.showImmediate){
      const exp = document.getElementById('explain'); if(exp) exp.classList.remove('hide');
      const st = document.getElementById('status');
      if(st) st.innerHTML = correct ? '✅ Correct' : `❌ Incorrect · Correct is <b>${String.fromCharCode(65+correctIndex)}</b>`;
    }else{
      const st = document.getElementById('status'); if(st) st.textContent='Answer recorded. Move on — explanations at the end.';
    }

    session.answers.push({id:q.id,pick,correct});
    answeredThis=true;
    if(nextBtn){ nextBtn.disabled=false; nextBtn.style.opacity=1; }
  }));

  // Keyboard support
  $$('#qArea .choice').forEach(ch=>ch.addEventListener('keydown',(e)=>{
    if(e.key==='Enter' || e.key===' '){ e.preventDefault(); ch.click(); }
  }));
}

function nextQuestion(){
  if(!session) return;
  if(!answeredThis){ alert('Please select an answer first.'); return; }
  if(session.index < session.list.length-1){ session.index++; showCurrent(); }
  else { finishSession(false); }
}

function finishSession(timeUp){
  session.ended=true;
  const seconds = Math.floor((Date.now()-session.start)/1000);
  const correct = session.answers.filter(a=>a.correct).length;
  const total = session.list.length;
  const score = correct/total;
  history.push({mode:session.mode,score,time:seconds,total,when:Date.now()}); store.set(HIST_KEY, history);

  $('#quiz')?.classList.add('hide'); $('#results')?.classList.remove('hide');
  $('#scoreLine') && ($('#scoreLine').textContent = `Score: ${Math.round(score*100)}% (${correct}/${total}) ${timeUp?'· Time up':''}`);
  $('#kCorrect') && ($('#kCorrect').textContent = `${correct}/${total}`);
  $('#kTime') && ($('#kTime').textContent=secondsToMMSS(seconds));
  $('#kMode') && ($('#kMode').textContent=session.mode);

  const bySec = {}; const byTopic = {};
  session.list.forEach((q,i)=>{
    const a=session.answers[i]; if(!a) return;
    if(!bySec[q.sec]) bySec[q.sec]={r:0,t:0};
    if(!byTopic[q.topic]) byTopic[q.topic]={r:0,t:0};
    bySec[q.sec].t++; if(a.correct) bySec[q.sec].r++;
    byTopic[q.topic].t++; if(a.correct) byTopic[q.topic].r++;
  });
  const secWrap=$('#bySection'); if(secWrap){ secWrap.innerHTML='<h3 style="margin-top:12px">Section Breakdown</h3>';
    Object.keys(bySec).forEach(s=>{
      const pct = Math.round(bySec[s].r/bySec[s].t*100);
      const div=document.createElement('div'); div.className='small'; div.innerHTML=`<div class="badge">${s}</div> <b>${pct}%</b> (${bySec[s].r}/${bySec[s].t})`; secWrap.appendChild(div);
    });
  }
  const topicWrap=$('#byTopic'); if(topicWrap){ topicWrap.innerHTML='<h3 style="margin-top:12px">Topic Breakdown</h3>';
    Object.keys(byTopic).forEach(t=>{
      const pct = Math.round(byTopic[t].r/byTopic[t].t*100);
      const div=document.createElement('div'); div.className='small'; div.innerHTML=`<div class="badge">${t}</div> <b>${pct}%</b> (${byTopic[t].r}/${byTopic[t].t})`; topicWrap.appendChild(div);
    });
  }

  renderHistory();

  // Exam-mode review
  if(!session.showImmediate){
    const review=document.createElement('div'); review.style.marginTop='14px';
    review.innerHTML = '<h3>Review & Explanations</h3>';
    session.list.forEach((q,i)=>{
      const a=session.answers[i];
      const correctIndex = (q._answer!=null)? q._answer : q.answer;
      const tag = a && a.correct ? '✅' : '❌';
      const block=document.createElement('div'); block.className='explain small';
      const choices = (q._choices||q.choices);
      block.innerHTML = `<div style="margin:6px 0"><b>${tag} Q${i+1}.</b> ${q.stem}</div>
                         <div><b>Answer:</b> ${String.fromCharCode(65+correctIndex)} — ${choices[correctIndex]}</div>
                         <div><b>Why:</b> ${q.why}</div>
                         <div><b>Terms:</b> ${q.terms}</div>
                         <div><b>Why others are wrong:</b><ul class="compact">${
                           (q.wrong||[]).map(w=>`<li>${w}</li>`).join('')
                         }</ul></div>
                         <div><b>Memory tip:</b> ${q.tip}</div>`;
      $('#results')?.appendChild(block);
    });
  }

  session=null; refreshKPIs();
}

function goHome(){ $('#results')?.classList.add('hide'); $('#home')?.classList.remove('hide'); }
function retry(){ goHome(); }

function renderHistory(){
  const wrap=document.getElementById('histList'); if(!wrap) return; wrap.innerHTML='';
  history.slice().reverse().slice(0,8).forEach(h=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div class="badge">${h.mode}</div>
      <div style="font-weight:700;margin-top:6px">${new Date(h.when).toLocaleString()}</div>
      <div class="small">Score: <b>${Math.round((h.score||0)*100)}%</b> · Time: ${secondsToMMSS(h.time||0)} · Qs: ${h.total}</div>`;
    wrap.appendChild(div);
  });
}

// Wire buttons (defensive: remove existing listeners by cloning)
function rebind(id, handler){
  const el=document.getElementById(id); if(!el) return;
  const newEl=el.cloneNode(true); el.parentNode.replaceChild(newEl, el);
  newEl.addEventListener('click', handler);
}
function wireButtons(){
  rebind('btnDaily', ()=> startSession({mode:'daily', timeLimit:null, showImmediate:true}));
  rebind('btnPractice', ()=> startSession({mode:'practice', timeLimit:null, showImmediate:true}));
  rebind('btnHard', ()=> startSession({mode:'hard', timeLimit: 60*60, showImmediate:true}));
  rebind('btnExam', ()=> startSession({mode:'exam', timeLimit: 150*60, showImmediate:false}));
  rebind('btnBooster', ()=>{
    const list = pickQuestions('booster'); if(!list){return;}
    session={mode:'booster',list,index:0,answers:[],start:Date.now(),timeLimit:null,ended:false,showImmediate:true};
    $('#home')?.classList.add('hide'); $('#results')?.classList.add('hide'); $('#quiz')?.classList.remove('hide');
    $('#modePill') && ($('#modePill').textContent='BOOSTER'); $('#qTotal') && ($('#qTotal').textContent=String(list.length)); $('#timer') && ($('#timer').textContent='—'); $('#catPill') && ($('#catPill').textContent='Weak Spots');
    showCurrent();
  });
  rebind('btnNext', nextQuestion);
}

document.addEventListener('DOMContentLoaded', ()=>{
  refreshKPIs();
  wireButtons();
});

</script>
</body></html>
