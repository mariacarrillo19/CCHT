<!DOCTYPE html><html lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CCHT Study Coach — Single File (v1.9)</title>
<style>

:root{--bg:#0b1220;--card:#0f172a;--ink:#e5e7eb;--muted:#94a3b8;--pri:#60a5fa;--ok:#22c55e;--bad:#ef4444;--chip:#1f2937}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1000px;margin:0 auto;padding:16px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid #233047;border-radius:14px;padding:16px}
h1{font-size:20px;margin:0 0 10px}
button{background:var(--pri);color:#0b1220;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
button.outline{background:transparent;border:1px solid var(--pri);color:var(--pri)}
.badge,.pill{display:inline-block;padding:3px 8px;border-radius:999px;background:var(--chip);color:#e2e8f0;font-size:12px}
.small{font-size:13px;color:var(--muted)}.muted{color:var(--muted)}
.hide{display:none}.list .item{padding:10px 0;border-top:1px solid #1e293b}
.kpi{display:flex;gap:10px;flex-wrap:wrap}
.kpi .cell{flex:1;min-width:180px;background:#0c1322;border:1px solid #1d2a3e;border-radius:12px;padding:12px}
.q-stem{font-weight:700;margin:8px 0}
.choice{display:flex;gap:10px;align-items:flex-start;border:1px solid #213047;border-radius:10px;padding:10px;margin:8px 0;cursor:pointer}
.choice .badge{background:#111827}
.choice.correct{border-color:#14532d;background:rgba(34,197,94,.1)}
.choice.incorrect{border-color:#7f1d1d;background:rgba(239,68,68,.08)}
.explain{margin-top:8px;border-left:3px solid #334155;padding-left:10px}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
.progress{height:8px;background:#111827;border-radius:999px;overflow:hidden}
.progress>div{height:100%;width:0;background:var(--pri)}
footer{color:#64748b;margin-top:16px;font-size:12px;text-align:center}
hr.sep{border:0;border-top:1px solid #1e293b;margin:12px 0}
ul.compact{margin:6px 0 0 18px;padding:0}

</style>
</head><body>
<div class="container">

  <div id="home" class="card">
    <div class="topbar">
      <div><h1>CCHT Study Coach</h1>
        <div class="small muted">Explanations after answer · Next fixed · Trend chart · <b>Commonly Missed (pre-loaded)</b></div>
      </div>
      <span class="pill" id="modePill">Home</span>
    </div>

    <div class="row" style="margin:10px 0">
      <button id="btnDaily">Daily Drill (10)</button>
      <button id="btnPractice" class="outline">Practice (30)</button>
      <button id="btnHard" class="outline">Hard Mode (60)</button>
      <button id="btnExam" class="outline">Timed Exam (150)</button>
      <button id="btnBooster" class="outline">Weak Areas Booster</button>
      <button id="btnMissed" class="outline">Commonly Missed</button>
    </div>

    <div class="kpi">
      <div class="cell"><div class="small">Today answered</div><div style="font-size:22px" id="todayKpi">0</div></div>
      <div class="cell"><div class="small">Weak spots saved</div><div style="font-size:22px" id="weakKpi">0</div></div>
      <div class="cell"><div class="small">Best recent</div><div style="font-size:22px" id="bestKpi">—</div></div>
    </div>

    <hr class="sep">
    <div class="small"><b>Score trend</b></div>
    <div id="trendMount" style="margin-top:6px"></div>

    <hr class="sep">
    <div class="small">
      <b>How to use:</b> Pick a mode. Answer first, then you'll see the <b>Why</b>, <b>Terms</b>, <b>Why others are wrong</b>, and a <b>Memory tip</b>. Tap <b>Next</b> to continue.
    </div>
  </div>

  <div id="quiz" class="card hide">
    <div class="topbar">
      <div><span class="pill" id="catPill">Mix</span> <span class="pill" id="countPill"><span id="qNum">1</span>/<span id="qTotal">10</span></span></div>
      <div class="pill" id="timer">—</div>
    </div>
    <div class="progress" style="margin:12px 0 6px"><div id="bar"></div></div>
    <div id="qArea"></div>
    <div class="row"><button id="btnNext" class="outline">Next →</button></div>
  </div>

  <div id="results" class="card hide">
    <h1>Results</h1>
    <div id="scoreLine" style="font-size:22px;margin-bottom:10px"></div>
    <div class="kpi">
      <div class="cell"><div class="small">Correct</div><div id="kCorrect" style="font-size:22px">0</div></div>
      <div class="cell"><div class="small">Time</div><div id="kTime" style="font-size:22px">—</div></div>
      <div class="cell"><div class="small">Mode</div><div id="kMode" style="font-size:22px">—</div></div>
    </div>
    <div id="bySection" style="margin-top:12px"></div>
    <div id="byTopic" style="margin-top:12px"></div>
    <h3 style="margin-top:14px">Recent Sessions</h3>
    <div id="histList" class="list"></div>
    <div class="row" style="margin-top:12px;"><button onclick="goHome()">Home</button><button class="outline" onclick="retry()">Retry</button></div>
    <div class="small muted" style="margin-top:10px">App v1.9 (single-file)</div>
  </div>

  <footer>If your browser blocks saving (private mode), quizzes still work — but streaks/booster history won’t persist.</footer>
</div>

<script>
const QUESTIONS = [
  {
    "id": 2001,
    "sec": "Clinical",
    "topic": "Emergencies",
    "stem": "Sudden chest pain + dyspnea with visible air in venous chamber. First action?",
    "choices": [
      "Stop ultrafiltration only",
      "Clamp venous line and stop pump; left Trendelenburg; O2",
      "Increase dialysate flow",
      "Continue and observe"
    ],
    "answer": 1,
    "why": "Air embolism risk \u2014 stop pump, clamp venous line, position left side head-down, oxygen.",
    "terms": "Air embolism: air in circulation causing obstruction.",
    "wrong": [
      "UF change alone does not stop air entry.",
      "\u2014",
      "Dialysate flow doesn't remove intravascular air.",
      "Observation delays critical response."
    ],
    "tip": "Clamp \u2022 Stop \u2022 Left \u2022 O2"
  },
  {
    "id": 2002,
    "sec": "Water",
    "topic": "Chloramine",
    "stem": "AAMI max total chlorine (free+combined) in product water:",
    "choices": [
      "0.1 mg/L",
      "0.5 mg/L",
      "1.0 mg/L",
      "0.01 mg/L"
    ],
    "answer": 0,
    "why": "Limit \u22640.1 mg/L to prevent hemolysis; test after first carbon.",
    "terms": "Total chlorine = free chlorine + chloramine.",
    "wrong": [
      "Too high.",
      "Too high.",
      "Too low to be practical."
    ],
    "tip": "One TENTH is the LIMIT."
  },
  {
    "id": 2003,
    "sec": "Machine",
    "topic": "Monitoring",
    "stem": "TMP rises while clearance falls. Most likely cause?",
    "choices": [
      "Dialyzer clotting/fouling",
      "Access recirculation",
      "Low conductivity",
      "High dialysate temp"
    ],
    "answer": 0,
    "why": "Clotting/fouling increases resistance \u2192 TMP up, clearance down.",
    "terms": "TMP: transmembrane pressure across dialyzer.",
    "wrong": [
      "\u2014",
      "Recirculation affects adequacy but not TMP directly.",
      "Dialysate mixing issue.",
      "Temperature not primary driver."
    ],
    "tip": "Gummed filter = high TMP."
  },
  {
    "id": 2004,
    "sec": "Water",
    "topic": "Endotoxin",
    "stem": "Ultrafilter downstream of RO primarily removes:",
    "choices": [
      "Hardness",
      "Chlorine",
      "Bacteria/endotoxin",
      "Sodium"
    ],
    "answer": 2,
    "why": "UF captures bacteria/pyrogens downstream of RO.",
    "terms": "Endotoxin: LPS from gram-negatives.",
    "wrong": [
      "Hardness via softener/RO.",
      "Chlorine via carbon.",
      "\u2014",
      "Sodium via RO."
    ],
    "tip": "Ultra = ultra-clean."
  },
  {
    "id": 2005,
    "sec": "Clinical",
    "topic": "Access",
    "stem": "New AVF without continuous thrill; weak diastolic bruit. Next step?",
    "choices": [
      "Proceed with cannulation",
      "Hold cannulation; report possible outflow stenosis",
      "Use smaller needles",
      "Apply tight tourniquet"
    ],
    "answer": 1,
    "why": "Loss of continuous thrill suggests stenosis/thrombosis \u2014 do not cannulate; escalate.",
    "terms": "Thrill: palpable vibration from blood flow.",
    "wrong": [
      "Unsafe.",
      "\u2014",
      "Needle size doesn't fix stenosis.",
      "Tourniquet worsens pressure."
    ],
    "tip": "No thrill? Don\u2019t drill."
  },
  {
    "id": 2006,
    "sec": "Water",
    "topic": "Concentrates",
    "stem": "Bicarbonate mixing error (too concentrated) causes:",
    "choices": [
      "Low conductivity alarm",
      "High conductivity alarm",
      "No alarm",
      "Air detector alarm"
    ],
    "answer": 1,
    "why": "Too much concentrate raises dialysate conductivity.",
    "terms": "Conductivity reflects ionic strength.",
    "wrong": [
      "Opposite.",
      "\u2014",
      "It will alarm.",
      "Unrelated."
    ],
    "tip": "Strong soup = strong conductance."
  },
  {
    "id": 2007,
    "sec": "Machine",
    "topic": "Safety",
    "stem": "Blood leak alarm + pink effluent. Best step?",
    "choices": [
      "Continue; sensor error",
      "Stop, test for blood leak; replace dialyzer/circuit",
      "Increase dialysate flow",
      "Silence alarm"
    ],
    "answer": 1,
    "why": "Treat as membrane breach until proven otherwise.",
    "terms": "Blood leak: RBCs crossing to dialysate.",
    "wrong": [
      "Unsafe.",
      "\u2014",
      "Not helpful.",
      "Unsafe."
    ],
    "tip": "Pink effluent = stop & swap."
  },
  {
    "id": 2008,
    "sec": "Water",
    "topic": "System Layout",
    "stem": "Correct pretreatment order to protect RO membranes:",
    "choices": [
      "RO \u2192 Softener \u2192 Carbon \u2192 Ultrafilter",
      "Multimedia \u2192 Softener \u2192 Carbon \u2192 RO \u2192 Ultrafilter",
      "Carbon \u2192 RO \u2192 Softener",
      "Softener \u2192 Ultrafilter \u2192 Carbon \u2192 RO"
    ],
    "answer": 1,
    "why": "MMF \u2192 Softener \u2192 Carbon \u2192 RO \u2192 UF.",
    "terms": "RO: reverse osmosis; UF: ultrafilter.",
    "wrong": [
      "Wrong order.",
      "\u2014",
      "Wrong order.",
      "Wrong order."
    ],
    "tip": "Sand \u2192 Soft \u2192 Carbon \u2192 RO \u2192 Ultra"
  },
  {
    "id": 2009,
    "sec": "Clinical",
    "topic": "Infection Control",
    "stem": "Best donning sequence:",
    "choices": [
      "Gloves \u2192 Gown \u2192 Mask/Resp \u2192 Eye",
      "Gown \u2192 Mask/Resp \u2192 Eye \u2192 Gloves",
      "Mask \u2192 Gloves \u2192 Gown \u2192 Eye",
      "Gown \u2192 Gloves \u2192 Mask \u2192 Eye"
    ],
    "answer": 1,
    "why": "Donning: Gown, Mask/Resp, Eye, then Gloves.",
    "terms": "Donning = putting on PPE.",
    "wrong": [
      "Gloves first = contam risk.",
      "\u2014",
      "Wrong order.",
      "Wrong order."
    ],
    "tip": "G-M-E-G"
  },
  {
    "id": 2010,
    "sec": "Water",
    "topic": "RO Mechanics",
    "stem": "RO high\u2011pressure pump cavitation presents as:",
    "choices": [
      "Smooth quiet operation",
      "Rattling/rumbling with pressure swings",
      "Only higher conductivity",
      "Only lower TMP"
    ],
    "answer": 1,
    "why": "Cavitation causes noise/vibration and unstable pressures; can damage pump.",
    "terms": "Cavitation: vapor bubble collapse due to NPSH issues.",
    "wrong": [
      "Opposite of symptom.",
      "\u2014",
      "May occur but not hallmark.",
      "TMP is dialyzer metric."
    ],
    "tip": "Cavitation = clatter + swings."
  }
];
</script>
<script>

const APP_VERSION = '1.9'; console.log('CCHT script version:', APP_VERSION);
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}
function storageAvailable(){try{const x='__t__';localStorage.setItem(x,x);localStorage.removeItem(x);return true}catch(e){return false}}
const STORAGE_OK = storageAvailable();
const store={get:(k,f)=>{if(!STORAGE_OK)return f;try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}},
             set:(k,v)=>{if(!STORAGE_OK)return;try{localStorage.setItem(k,JSON.stringify(v))}catch{}}};
const $=sel=>document.querySelector(sel), $$=sel=>Array.from(document.querySelectorAll(sel));
function secondsToMMSS(s){const m=Math.floor(s/60),ss=('0'+(s%60)).slice(-2);return `${m}:${ss}`}
const WRONG_KEY='ccht_wrong_v6', STATS_KEY='ccht_stats_v6', HIST_KEY='ccht_hist_v6', PERF_KEY='ccht_perf_v6';
let wrongSet=new Set(store.get(WRONG_KEY,[]));
let stats=store.get(STATS_KEY,{answeredToday:0});
let history=store.get(HIST_KEY,[]);
let perf=store.get(PERF_KEY,{});
let session=null; let answeredThis=false;
function ensurePerf(sec,topic){ if(!perf[sec]) perf[sec]={}; if(!perf[sec][topic]) perf[sec][topic]={right:0,total:0}; }
function refreshKPIs(){ $('#todayKpi').textContent=String(stats.answeredToday||0); $('#weakKpi').textContent=String(wrongSet.size||0); const last=history[history.length-1]; $('#bestKpi').textContent= last? `${Math.round((last.score||0)*100)}%` : '—'; }
function pickQuestions(mode){
  const pool = shuffle(QUESTIONS.slice()); pool.forEach(q=>{ const zip=q.choices.map((c,i)=>({c,i})); shuffle(zip); q._choices=zip.map(z=>z.c); q._answer=zip.findIndex(z=>z.i===q.answer); });
  if(mode==='daily') return pool.slice(0,10);
  if(mode==='practice') return pool.slice(0,30);
  if(mode==='hard') return pool.slice(0,Math.min(60,pool.length));
  if(mode==='exam'){ const need=150,out=[]; while(out.length<need){ out.push(...shuffle(pool)); } return out.slice(0,need); }
  return pool.slice(0,10);
}
function startSession({mode,timeLimit=null,showImmediate=true}){
  const list = pickQuestions(mode); if(!list) return;
  session={mode,list,index:0,answers:[],start:Date.now(),timeLimit,ended:false,showImmediate};
  $('#home').classList.add('hide'); $('#results').classList.add('hide'); $('#quiz').classList.remove('hide');
  $('#modePill').textContent=mode.toUpperCase(); $('#qTotal').textContent=String(list.length); $('#timer').textContent=timeLimit?secondsToMMSS(timeLimit):'—'; $('#catPill').textContent='Mix';
  showCurrent();
}
function showCurrent(){
  answeredThis=false; const nextBtn=document.getElementById('btnNext'); nextBtn.disabled=true; nextBtn.style.opacity=0.6;
  const q=session.list[session.index]; $('#qNum').textContent=String(session.index+1); $('#bar').style.width=((session.index)/session.list.length*100)+'%';
  const area=$('#qArea'); area.innerHTML='';
  const choicesHtml=(q._choices||q.choices).map((c,i)=>`<div class="choice" data-i="${i}" role="button" tabindex="0"><div class="badge">${String.fromCharCode(65+i)}</div><div>${c}</div></div>`).join('');
  area.innerHTML = `<div class="q-stem">${q.stem} <span class="pill" style="margin-left:6px">${q.sec}</span> <span class="pill" style="margin-left:6px">${q.topic}</span></div>${choicesHtml}<div class="explain small ${session.showImmediate?'hide':''}" id="explain"><div><b>Why:</b> ${q.why}</div><div><b>Terms:</b> ${q.terms}</div><div><b>Why others are wrong:</b><ul class="compact">${(q.wrong||[]).map(w=>`<li>${w}</li>`).join('')}</ul></div><div><b>Memory tip:</b> ${q.tip}</div></div>`;
  const status=document.createElement('div'); status.id='status'; status.className='small muted'; status.style.marginTop='6px'; status.textContent=session.showImmediate?'Select an answer to see the explanation, then tap Next.':'Practice exam mode — answers at the end.'; area.appendChild(status);
  $$('#qArea .choice').forEach(ch=>ch.addEventListener('click',()=>{
    if(ch.classList.contains('locked')) return;
    const pick=Number(ch.dataset.i); const correctIndex=(q._answer!=null)?q._answer:q.answer;
    $$('#qArea .choice').forEach((n,i)=>{ n.classList.add('locked'); if(i===correctIndex) n.classList.add('correct'); if(i===pick && i!==correctIndex) n.classList.add('incorrect'); });
    const correct = pick===correctIndex;
    stats.answeredToday+=1; store.set(STATS_KEY, stats); ensurePerf(q.sec,q.topic); perf[q.sec][q.topic].total += 1; if(correct) perf[q.sec][q.topic].right += 1; store.set(PERF_KEY, perf);
    if(!correct){ wrongSet.add(q.id); bumpMiss(q.id); } else { wrongSet.delete(q.id); } store.set(WRONG_KEY, Array.from(wrongSet));
    if(session.showImmediate){ document.getElementById('explain').classList.remove('hide'); document.getElementById('status').innerHTML = correct ? '✅ Correct' : `❌ Incorrect · Correct is <b>${String.fromCharCode(65+correctIndex)}</b>`; } else { document.getElementById('status').textContent='Answer recorded. Move on — explanations at the end.'; }
    session.answers.push({id:q.id,pick,correct}); answeredThis=true; nextBtn.disabled=false; nextBtn.style.opacity=1;
  }));
}
function nextQuestion(){ if(!session) return; if(!answeredThis){ alert('Please select an answer first.'); return; } if(session.index < session.list.length-1){ session.index++; showCurrent(); } else { finishSession(false); } }
function finishSession(timeUp){ session.ended=true; const seconds=Math.floor((Date.now()-session.start)/1000); const correct = session.answers.filter(a=>a.correct).length; const total=session.list.length; const score=correct/total; history.push({mode:session.mode,score,time:seconds,total,when:Date.now()}); store.set(HIST_KEY, history);
  $('#quiz').classList.add('hide'); $('#results').classList.remove('hide');
  $('#scoreLine').textContent=`Score: ${Math.round(score*100)}% (${correct}/${total}) ${timeUp?'· Time up':''}`; $('#kCorrect').textContent=`${correct}/${total}`; $('#kTime').textContent=secondsToMMSS(seconds); $('#kMode').textContent=session.mode;
  const bySec={}, byTopic={}; session.list.forEach((q,i)=>{ const a=session.answers[i]; if(!a) return; if(!bySec[q.sec]) bySec[q.sec]={r:0,t:0}; if(!byTopic[q.topic]) byTopic[q.topic]={r:0,t:0}; bySec[q.sec].t++; if(a.correct) bySec[q.sec].r++; byTopic[q.topic].t++; if(a.correct) byTopic[q.topic].r++; });
  const secWrap=$('#bySection'); secWrap.innerHTML='<h3 style="margin-top:12px">Section Breakdown</h3>'; Object.keys(bySec).forEach(s=>{ const pct=Math.round(bySec[s].r/bySec[s].t*100); const div=document.createElement('div'); div.className='small'; div.innerHTML=`<div class="badge">${s}</div> <b>${pct}%</b> (${bySec[s].r}/${bySec[s].t})`; secWrap.appendChild(div); });
  const topicWrap=$('#byTopic'); topicWrap.innerHTML='<h3 style="margin-top:12px">Topic Breakdown</h3>'; Object.keys(byTopic).forEach(t=>{ const pct=Math.round(byTopic[t].r/byTopic[t].t*100); const div=document.createElement('div'); div.className='small'; div.innerHTML=`<div class="badge">${t}</div> <b>${pct}%</b> (${byTopic[t].r}/${byTopic[t].t})`; topicWrap.appendChild(div); });
  renderHistory();
  if(!session.showImmediate){ const review=document.createElement('div'); review.style.marginTop='14px'; review.innerHTML='<h3>Review & Explanations</h3>'; session.list.forEach((q,i)=>{ const a=session.answers[i]; const correctIndex=(q._answer!=null)?q._answer:q.answer; const tag=a&&a.correct?'✅':'❌'; const block=document.createElement('div'); block.className='explain small'; const choices=(q._choices||q.choices);
    block.innerHTML=`<div style="margin:6px 0"><b>${tag} Q${i+1}.</b> ${q.stem}</div><div><b>Answer:</b> ${String.fromCharCode(65+correctIndex)} — ${choices[correctIndex]}</div><div><b>Why:</b> ${q.why}</div><div><b>Terms:</b> ${q.terms}</div><div><b>Why others are wrong:</b><ul class="compact">${(q.wrong||[]).map(w=>`<li>${w}</li>`).join('')}</ul></div><div><b>Memory tip:</b> ${q.tip}</div>`; $('#results').appendChild(block); }); }
  session=null; refreshKPIs();
}
function goHome(){ $('#results').classList.add('hide'); $('#home').classList.remove('hide'); } function retry(){ goHome(); }
function renderHistory(){ const wrap=document.getElementById('histList'); if(!wrap) return; wrap.innerHTML=''; history.slice().reverse().slice(0,8).forEach(h=>{ const div=document.createElement('div'); div.className='item'; div.innerHTML=`<div class="badge">${h.mode}</div><div style="font-weight:700;margin-top:6px">${new Date(h.when).toLocaleString()}</div><div class="small">Score: <b>${Math.round((h.score||0)*100)}%</b> · Time: ${secondsToMMSS(h.time||0)} · Qs: ${h.total}</div>`; wrap.appendChild(div); }); }
document.getElementById('btnDaily').addEventListener('click',()=> startSession({mode:'daily', timeLimit:null, showImmediate:true}));
document.getElementById('btnPractice').addEventListener('click',()=> startSession({mode:'practice', timeLimit:null, showImmediate:true}));
document.getElementById('btnHard').addEventListener('click',()=> startSession({mode:'hard', timeLimit: 60*60, showImmediate:true}));
document.getElementById('btnExam').addEventListener('click',()=> startSession({mode:'exam', timeLimit: 150*60, showImmediate:false}));
document.getElementById('btnBooster').addEventListener('click',()=>{ const list = pickQuestions('practice'); session={mode:'booster',list,index:0,answers:[],start:Date.now(),timeLimit:null,ended:false,showImmediate:true}; $('#home').classList.add('hide'); $('#results').classList.add('hide'); $('#quiz').classList.remove('hide'); $('#modePill').textContent='BOOSTER'; $('#qTotal').textContent=String(list.length); $('#timer').textContent='—'; $('#catPill').textContent='Weak Spots'; showCurrent(); });
document.getElementById('btnNext').addEventListener('click', nextQuestion);


// Trend chart
function renderTrend(){
  const mount = document.getElementById('trendMount'); if(!mount) return;
  const data = history.slice(-15).map(h=>Math.round((h.score||0)*100));
  mount.innerHTML = '';
  if(data.length===0){ const p=document.createElement('div'); p.className='small muted'; p.textContent='No sessions yet — take a quiz to start your trend.'; mount.appendChild(p); return; }
  const W=320,H=100,pad=8, max=100,min=0; const step=(W-2*pad)/Math.max(1,data.length-1); const y=v=> H-pad - ((v-min)/(max-min)*(H-2*pad));
  const NS='http://www.w3.org/2000/svg'; const svg=document.createElementNS(NS,'svg'); svg.setAttribute('viewBox',`0 0 ${W} ${H}`); svg.style.width='100%'; svg.style.maxWidth='360px';
  const bg=document.createElementNS(NS,'rect'); bg.setAttribute('x','0'); bg.setAttribute('y','0'); bg.setAttribute('width',W); bg.setAttribute('height',H); bg.setAttribute('fill','#0c1322'); bg.setAttribute('rx','8'); svg.appendChild(bg);
  const target=70; const line=document.createElementNS(NS,'line'); line.setAttribute('x1',pad); line.setAttribute('x2',W-pad); line.setAttribute('y1',y(target)); line.setAttribute('y2',y(target)); line.setAttribute('stroke','#475569'); line.setAttribute('stroke-dasharray','4 4'); svg.appendChild(line);
  let d=''; data.forEach((v,i)=>{ const px=pad+i*step, py=y(v); d+=(i===0?`M ${px} ${py}`:` L ${px} ${py}`); });
  const path=document.createElementNS(NS,'path'); path.setAttribute('d',d); path.setAttribute('fill','none'); path.setAttribute('stroke','#60a5fa'); path.setAttribute('stroke-width','2'); svg.appendChild(path);
  data.forEach((v,i)=>{ const cx=pad+i*step, cy=y(v); const c=document.createElementNS(NS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r','3'); c.setAttribute('fill','#60a5fa'); svg.appendChild(c); });
  const lab=document.createElement('div'); lab.className='small muted'; lab.style.marginTop='6px'; lab.textContent=`Last ${data.length} sessions · Avg ${Math.round(data.reduce((a,b)=>a+b,0)/data.length)}% · Target 70%`; mount.appendChild(svg); mount.appendChild(lab);
}
(function(){ const orig=window.goHome; window.goHome=function(){ orig && orig(); renderTrend(); }; })();
document.addEventListener('DOMContentLoaded', ()=> setTimeout(renderTrend, 100));


// Miss tracking + preseed
const MISS_KEY='ccht_miss_v1'; let missCounts = store.get(MISS_KEY, {});
const HIGH_MISS_TOPICS = new Set(['Chloramine','Concentrates','Monitoring','Emergencies','Endotoxin','System Layout','Pretreatment','Access','Infection Control','Safety','RO Mechanics','Hardness']);
(function(){ if(Object.keys(missCounts).length) return; const candidates=QUESTIONS.filter(q=>HIGH_MISS_TOPICS.has(q.topic)); const take=candidates.slice(0,40); let weight=5; take.forEach((q,idx)=>{ const w=Math.max(1, weight - Math.floor(idx/8)); missCounts[q.id]=w; }); store.set(MISS_KEY, missCounts); })();
function bumpMiss(id){ missCounts[id]=(missCounts[id]||0)+1; store.set(MISS_KEY, missCounts); }
function pickCommonlyMissed(N=30){ const entries=Object.entries(missCounts).sort((a,b)=>(b[1]||0)-(a[1]||0)); let ids=entries.filter(e=>(e[1]||0)>0).slice(0,N*2).map(e=>Number(e[0])); if(!ids.length){ ids=Array.from(wrongSet).slice(0,N*2).map(Number); } const candidates=QUESTIONS.filter(q=>ids.includes(q.id)); if(!candidates.length){ alert('No commonly missed questions yet — do a session first.'); return null; } return shuffle(candidates).slice(0,N); }
document.getElementById('btnMissed').addEventListener('click',()=>{ const list=pickCommonlyMissed(30); if(!list) return; session={mode:'commonly-missed',list,index:0,answers:[],start:Date.now(),timeLimit:null,ended:false,showImmediate:true}; document.getElementById('home').classList.add('hide'); document.getElementById('results').classList.add('hide'); document.getElementById('quiz').classList.remove('hide'); document.getElementById('modePill').textContent='COMMONLY MISSED'; document.getElementById('qTotal').textContent=String(list.length); document.getElementById('timer').textContent='—'; document.getElementById('catPill').textContent='Missed'; showCurrent(); });

</script>
</body></html>
